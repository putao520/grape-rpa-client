function getDomNodes(_node, red){
    const nodes = red.nodes.getAllFlowNodes(_node)
    const selectors = []
    for(let node of nodes){
        if( node !== _node ) {
            switch (node.type) {
                case "dom-operator":
                case "dom-read":
                case "dom-wait":
                    if (node.selector !== '') {
                        selectors.push({
                            'type': node.selectorType,
                            'name': node.selectorName ? node.selectorName : node.selector,
                            'selector': node.selector,
                        })
                    }
            }
        }
    }
    return selectors
}

function init_dom_library(node, red, selector, nameSelector, selectSelector){
    const arr = getDomNodes(node, red)
    const hunger = $(selector)
    if( hunger.length > 0 ){
        hunger.html(`<option value='xpath~'>${red._("node-red:browser.label.dry")}</option>`)
        for(let item of arr){
            hunger.append(`<option value='${item.type}~${item.selector}'>${item.name}</option>`)
        }
    }
    $(selector).on("change", function(){
        const val = $(this).val()
        const txt = $(this).find("option:selected").text()
        if( val ){
            const arr = val.split("~")
            if( arr.length === 2 ){
                const type = arr[0]
                const selector = arr[1]
                $(selectSelector).typedInput('type', type)
                $(selectSelector).typedInput('value', selector)
                if( selector ){
                    $(nameSelector).val(txt)
                } else {
                    $(nameSelector).val("")
                }
            }
        }
    })
}


var message_cb = undefined
function do_dom_message(e) {
    if (message_cb) {
        message_cb(e)
    }
}

// 安装消息服务
function init_dom_ipc(cb) {
    message_cb = cb
    if( window.rpa ){
        window.rpa.onIpcMessage(message => {
            if (message_cb) {
                message_cb(message)
            }
        })
    }
}

// 关闭消息服务
function remove_init_dom_ipc() {
    message_cb = undefined
}

// 发送消息
function send_dom_ipc(message, target) {
    if( window.rpa ){
        window.rpa.sendIpcMessage(message, target)
    }
}
