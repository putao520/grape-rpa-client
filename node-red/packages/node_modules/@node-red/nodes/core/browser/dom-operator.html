<script type="text/javascript">
  RED.nodes.registerType('dom-operator', {
    category: 'browser',
    color: '#a6bbcf',
    defaults: {
      browserName: {value: "", required: true},
      selector: {value: "", required: true},
      selectorName: {value: "", required: true},
      selectorType: {value: "xpath"},
      operator: {value: "click"},
      fill: {value: ""},
      fillMode: {value: false},
      color: {value: "#000000"},
      dateToday: {value: false},
      date: {value: dayjs().format("YYYY-MM-DD")},
      dayOffset: {value: 0},
      datetimeNow: {value: false},
      datetime: {value: dayjs().format("YYYY-MM-DDTHH:mm")},
      hourOffset: {value: 0},
      file: {value: ""},
      files: {value: ""},
      folder: {value: ""},
      image: {value: ""},
      dateCurrentMonth: {value: false},
      yearAndMonth: {value: dayjs().format("YYYY-MM")},
      monthOffset: {value: 0},
      dateCurrentWeek: {value: false},
      yearAndWeek: {value: dayjs().format("YYYY-MM-DD")},
      weekOffset: {value: 0},
      dateCurrentTime: {value: false},
      time: {value: dayjs().format("HH:mm")},
      minuteOffset: {value: 0},
      dateCurrentTimeSecond: {value: false},
      timeSecond: {value: dayjs().format("HH:mm:ss")},
      secondOffset: {value: 0},
      number: {value: 0},
      rangeNumber: {value: 0},
      ctrlState: {value: false},
      atlState: {value: false},
      shiftState: {value: false},
      keyState: {value: ""},
      innerBrowser: {value: undefined},
      selectOptionType:{value: "none"},
      selectOrderType:{value: "first"},
      selectOrderNth:{value: 1},
      selectText:{value: ""},
      selectValue:{value: ""},
      selectArray:{value: "[]"},
      __allProps:{value: {}},
    },
    inputs: 1,
    outputs: 1,
    icon: "file.png",
    paletteLabel: RED._("node-red:browser.dom-operator"),
    label: function () {
      if (!this.selector) {
        return this._("browser.dom-operator");
      }
      return (this.selectorName ? this._("browser.operator.target") + ":" + this.selectorName : "")
    },
    oneditprepare: function () {
      const _self = this
      initBrowserDialog(this, result=>{
        if (result) {
          _self.__allProps = result.props
        }
      })
      // 根据选项设置内容显示
      $("#node-input-operator").on("change", () => {
        const v = $("#node-input-operator").val()
        SwitchOperatorAreaDom(v)
      });
      // 今日日期选择器界面控制
      $("#node-input-dateToday").on("change", () => {
        const v = $("#node-input-dateToday");
        if( !v.is(":hidden") ){
          v.prop("checked") ? $("#div-input-date").hide() : $("#div-input-date").show()
        }
      });
      $("#node-input-datetimeNow").on("change", () => {
        const v = $("#node-input-datetimeNow")
        if( !v.is(":hidden") ) {
            v.prop("checked") ? $("#div-input-datetime").hide() : $("#div-input-datetime").show()
        }
      });
      $("#node-input-dateCurrentMonth").on("change", () => {
        const v = $("#node-input-dateCurrentMonth")
        if( !v.is(":hidden") ) {
          v.prop("checked") ? $("#div-input-yearAndMonth").hide() : $("#div-input-yearAndMonth").show()
        }
      });
      $("#node-input-dateCurrentWeek").on("change", () => {
        const v = $("#node-input-dateCurrentWeek")
        if( !v.is(":hidden") ) {
          v.prop("checked") ? $("#div-input-yearAndWeek").hide() : $("#div-input-yearAndWeek").show()
        }
      });
      $("#node-input-dateCurrentTime").on("change", () => {
        const v = $("#node-input-dateCurrentTime")
        if( !v.is(":hidden") ) {
          v.prop("checked") ? $("#div-input-time").hide() : $("#div-input-time").show()
        }
      });
      $("#node-input-dateCurrentTimeSecond").on("change", () => {
        const v = $("#node-input-dateCurrentTimeSecond")
        if( !v.is(":hidden") ) {
          v.prop("checked") ? $("#div-input-timeSecond").hide() : $("#div-input-timeSecond").show()
        }
      });
      // 初始化文件夹选择器
      initInputFileControl(
              [{text: "#node-input-file", input: "#node-input-fileWrap", label: "#node-input-fileSelected"}],
              [{text: "#node-input-files", input: "#node-input-filesWrap", label: "#node-input-filesSelected"}],
              [{text: "#node-input-folder", input: "#node-input-folderWrap", label: "#node-input-folderSelected"}]
      )
      // 初始化图片选择器
      /*
      initInputImageControl(
              [{text: "#node-input-image", input: "#node-input-imageWrap", view: "#node-input-imageView"}]
      )
      */
      // 初始化数字范围选择器
      initInputRangeControl([{input: "#node-input-rangeNumber", view: "#node-input-rangeView"}])
      // 初始化快捷键选择器
      new initSelectPlane(RED, {
        dependencies: "#div-input-selectOption",
        value: "none",
        component: "#node-input-selectOptionType",
        options: [
          { value: "none", label: "browser.label.none", component: [] },
          { value: "order", label: "browser.label.select-order-by", component: ["#div-input-selectOrderWarp"] },
          { value: "text", label: "browser.label.select-text-contains", component: ["#div-input-selectText"] },
          { value: "value", label: "browser.label.select-value-contains", component: ["#div-input-selectValue"] },
        ]
      })
      new initSelectPlane(RED, {
        dependencies: "#div-input-selectOption",
        value: "first",
        component: "#node-input-selectOrderType",
        options: [
          {value: "first", label: "browser.operator.select-byFirst", component:[]},
          {value: "last", label: "browser.operator.select-byLast", component:[]},
          {value: "nth", label: "browser.operator.select-byIndex", component:["#div-input-selectOrderNth"]},
        ]
      })
      // 初始化select多选选择器
      $("#node-input-selected-container")
              .css('min-height','150px')
              .css('min-width','450px')
      buildMultipleSelectTable("#node-input-selected-container", "#node-input-selectArray")

      // 初始化选择器触发器
      init_operator_selector(operatorTable, "#node-input-selector","#node-input-operator", this)
    },
    oneditsave: function () {
      closeBrowserDialog(this)
    },
    oneditcancel: function () {
      closeBrowserDialog(this)
    }
  });

  function SwitchOperatorAreaDom(v) {
    operatorTable.switch(v)
  }
  const operatorTable = new operatorFormSwitch(RED);
</script>

<script type="text/html" data-template-name="dom-operator">
  <!-- 网页对象 -->
  <div class="form-row">
    <label for="node-input-browserName"><i class="fa fa-tag"></i><span data-i18n="browser.label.browserName"></span></label>
    <select id="node-input-browserName">
    </select>
  </div>
  <!-- 元素库 -->
  <div class="form-row">
    <label for="node-input-domLibrary"><i class="fa fa-tag"></i><span
            data-i18n="browser.label.domLibrary"></span></label>
    <select style="width:150px" id="node-input-domLibrary">
    </select>
    <button id="node-input-catchBtn" type="button" class="red-ui-button" data-i18n="browser.label.findDom"></button>
  </div>
  <!-- 元素选择器 -->
  <div class="form-row">
    <label for="node-input-selector"><i class="fa fa-tag"></i><span
            data-i18n="browser.label.selector"></span></label>
    <input type="text" id="node-input-selector">
    <input type="hidden" id="node-input-selectorType">
  </div>
  <!-- 元素名称 -->
  <div class="form-row">
    <label for="node-input-selectorName"><i class="fa fa-tag"></i><span
            data-i18n="browser.label.selector-name"></span></label>
    <input type="text" id="node-input-selectorName">
  </div>
  <!-- 操作内容 -->
  <div class="form-row">
    <label for="node-input-operator"><i class="fa fa-tag"></i><span
            data-i18n="browser.label.operator"></span></label>
    <input type="text" id="node-input-operator">
  </div>
  <!-- 输入内容框 -->
  <div class="form-row" id="div-input-fill" style="display: none">
    <label for="node-input-fill"><i class="fa fa-tag"></i><span data-i18n="browser.label.fill"></span></label>
    <input type="text" id="node-input-fill"/>
  </div>
  <div class="form-row" id="div-input-fillMode" style="display: none">
    <label><i class="fa fa-tag"></i><span data-i18n="browser.operator.fillMode"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-fillMode"><label style="width:auto; margin-top:7px;" for="node-input-fillMode"><span data-i18n="browser.mode.yes"></span></label><br/>
  </div>
  <!-- 按键区域 -->
  <div class="form-row" id="div-input-press" style="display: none">
    <label for="node-input-ctrlState"><i class="fa fa-tag"></i><span
            data-i18n="browser.label.press-group"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-ctrlState"><label
          style="width:auto; margin-top:7px;" for="node-input-ctrlState"><span>CTRL</span></label><br/>
    <label for="node-input-atlState"><i class="fa fa-tag"></i><span
            data-i18n="browser.label.press-group"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox"
           id="node-input-atlState"><label style="width:auto; margin-top:7px;"
                                           for="node-input-atlState"><span>ATL</span></label><br/>
    <label for="node-input-shiftState"><i class="fa fa-tag"></i><span data-i18n="browser.label.press-group"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox"
           id="node-input-shiftState"><label style="width:auto; margin-top:7px;" for="node-input-shiftState"><span>SHIFT</span></label><br/>
    <label for="node-input-keyState"><i class="fa fa-tag"></i><span data-i18n="browser.label.press"></span></label>
    <input type="text" id="node-input-keyState"/>
  </div>
  <!-- 密码输入区域 -->
  <!-- 颜色输入区域 -->
  <div class="form-row" id="div-input-color" style="display: none">
    <label for="node-input-color"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-color"></span></label>
    <input type="color" id="node-input-color"/>
  </div>
  <!-- 日期输入区域(前几天/后几天) -->
  <div class="form-row" id="div-input-dateToday" style="display: none">
    <label><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-date"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-dateToday"><label style="width:auto; margin-top:7px;" for="node-input-dateToday"><span data-i18n="browser.label.datetime-today"></span></label><br/>
  </div>
  <div class="form-row" id="div-input-date" style="display: none">
    <label for="node-input-date"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-date"></span></label>
    <input type="date" id="node-input-date" required="required"/>
  </div>
  <div class="form-row" id="div-input-dayOffset" style="display: none">
    <label for="node-input-dayOffset"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-date-offset"></span></label>
    <input type="number" id="node-input-dayOffset"/>
  </div>
  <!-- 日期时间输入区域 -->
  <div class="form-row" id="div-input-datetimeNow" style="display: none">
    <label><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-datetime"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-datetimeNow"><label style="width:auto; margin-top:7px;" for="node-input-datetimeNow"><span data-i18n="browser.label.datetime-now"></span></label><br/>
  </div>
  <div class="form-row" id="div-input-datetime" style="display: none">
    <label for="node-input-datetime"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-datetime"></span></label>
    <input type="datetime-local" id="node-input-datetime" required="required"/>
  </div>
  <div class="form-row" id="div-input-hourOffset" style="display: none">
    <label for="node-input-hourOffset"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-time-offset"></span></label>
    <input type="number" id="node-input-hourOffset"/>
  </div>
  <!-- 文件输入区域(单个) -->
  <div class="form-row" id="div-input-file" style="display: none">
    <label for="node-input-fileWrap"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-file"></span></label>
    <input type="file" id="node-input-fileWrap"/>
    <input type="text" id="node-input-file" style="display: none"/>
    <label id="node-input-fileSelected" style="width: auto"></label>
  </div>
  <!-- 文件输入区域(多个) -->
  <div class="form-row" id="div-input-files" style="display: none">
    <label for="node-input-filesWrap"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-files"></span></label>
    <input type="file" id="node-input-filesWrap" multiple/>
    <input type="text" id="node-input-files" style="display: none"/>
    <label id="node-input-filesSelected" style="width: auto"></label>
  </div>
  <!-- 文件输入区域(文件夹) -->
  <div class="form-row" id="div-input-folder" style="display: none">
    <label for="node-input-folderWrap"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-folderWrap"></span></label>
    <input type="file" id="node-input-folderWrap" multiple webkitdirectory/>
    <input type="text" id="node-input-folder" style="display: none"/>
    <label id="node-input-folderSelected" style="width: auto"></label>
  </div>
  <!-- 图片输入区域 -->
  <div class="form-row" id="div-input-image" style="display: none">
    <label for="node-input-imageWrap"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-image"></span></label>
    <input type="file" id="node-input-imageWrap" accept="image/*"/>
    <input type="text" id="node-input-image" style="display: none"/>
    <label for="node-input-imageView"><i class="fa fa-tag"></i><span data-i18n="browser.label.image-view"></span></label>
    <img id="node-input-imageView" src="" style="width: auto;height: auto; max-width: 200px;max-height: 200px;" alt="图片为空"/>
  </div>
  <!-- 年月输入区域(前几月/后几月) -->
  <div class="form-row" id="div-input-dateCurrentMonth" style="display: none">
    <label><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-yearAndMonth"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-dateCurrentMonth"><label style="width:auto; margin-top:7px;" for="node-input-dateCurrentMonth"><span data-i18n="browser.label.date-currentMonth"></span></label><br/>
  </div>
  <div class="form-row" id="div-input-yearAndMonth" style="display: none">
    <label for="node-input-yearAndMonth"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-yearAndMonth"></span></label>
    <input type="month" id="node-input-yearAndMonth" required="required"/>
  </div>
  <div class="form-row" id="div-input-monthOffset" style="display: none">
    <label for="node-input-monthOffset"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-month-offset"></span></label>
    <input type="number" id="node-input-monthOffset"/>
  </div>
  <!-- 年周输入区域(前几周/后几周) -->
  <div class="form-row" id="div-input-dateCurrentWeek" style="display: none">
    <label><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-yearAndWeek"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-dateCurrentWeek"><label style="width:auto; margin-top:7px;" for="node-input-dateCurrentWeek"><span data-i18n="browser.label.date-currentWeek"></span></label><br/>
  </div>
  <div class="form-row" id="div-input-yearAndWeek" style="display: none">
    <label for="node-input-yearAndWeek"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-yearAndWeek"></span></label>
    <input type="week" id="node-input-yearAndWeek" required="required"/>
  </div>
  <div class="form-row" id="div-input-weekOffset" style="display: none">
    <label for="node-input-weekOffset"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-week-offset"></span></label>
    <input type="number" id="node-input-weekOffset"/>
  </div>
  <!-- 时间输入区域(前几分钟/后几分钟) -->
  <div class="form-row" id="div-input-dateCurrentTime" style="display: none">
    <label><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-time"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-dateCurrentTime"><label style="width:auto; margin-top:7px;" for="node-input-dateCurrentTime"><span data-i18n="browser.label.date-currentTime"></span></label><br/>
  </div>
  <div class="form-row" id="div-input-time" style="display: none">
    <label for="node-input-time"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-time"></span></label>
    <input type="time" id="node-input-time" required="required"/>
  </div>
  <div class="form-row" id="div-input-minuteOffset" style="display: none">
    <label for="node-input-minuteOffset"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-minute-offset"></span></label>
    <input type="number" id="node-input-minuteOffset"/>
  </div>
  <!-- 时间输入区域(前几秒/后几秒) -->
  <div class="form-row" id="div-input-dateCurrentTimeSecond" style="display: none">
    <label><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-time-second"></span></label>
    <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-dateCurrentTimeSecond"><label style="width:auto; margin-top:7px;" for="node-input-dateCurrentTimeSecond"><span data-i18n="browser.label.date-currentTime"></span></label><br/>
  </div>
  <div class="form-row" id="div-input-timeSecond" style="display: none">
    <label for="node-input-timeSecond"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-time-second"></span></label>
    <input type="time" id="node-input-timeSecond" step="1" required="required"/>
  </div>
  <div class="form-row" id="div-input-secondOffset" style="display: none">
    <label for="node-input-secondOffset"><i class="fa fa-tag"></i><span data-i18n="browser.operator.select-second-offset"></span></label>
    <input type="number" id="node-input-secondOffset"/>
  </div>
  <!-- 数字 -->
  <div class="form-row" id="div-input-number" style="display: none">
    <label for="node-input-number"><i class="fa fa-tag"></i><span data-i18n="browser.operator.fill-number"></span></label>
    <input type="number" id="node-input-number"/>
  </div>
  <!-- 数字范围 -->
  <div class="form-row" id="div-input-rangeNumber" style="display: none">
    <label for="node-input-rangeNumber"><i class="fa fa-tag"></i><span data-i18n="browser.operator.fill-number-range"></span></label>
    <input type="range" id="node-input-rangeNumber"/>
    <label for="node-input-rangeView"><i class="fa fa-tag"></i><span data-i18n="browser.label.label"></span></label>
    <span id="node-input-rangeView">0</span>
  </div>
  <!-- 单选输入区域 -->
  <!-- 下拉选项区域(单选) -->
  <div class="form-row" id="div-input-selectOptionWarp" style="display: none">
    <div class="form-row" id="div-input-selectOption">
      <label for="node-input-selectOptionType"><i class="fa fa-tag"></i><span
              data-i18n="browser.operator.select-type"></span></label>
      <input type="text" id="node-input-selectOptionType">
    </div>
    <div id="div-input-selectOrderWarp" style="display: none">
      <div class="form-row" id="div-input-selectOrder">
        <label for="node-input-selectOrderType"><i class="fa fa-tag"></i><span
                data-i18n="browser.label.select-order-by"></span></label>
        <input type="text" id="node-input-selectOrderType">
      </div>
      <div class="form-row" id="div-input-selectOrderNth" style="display: none">
        <label for="node-input-selectOrderNth"><i class="fa fa-tag"></i><span
                data-i18n="browser.operator.select-order"></span></label>
        <input type="number" id="node-input-selectOrderNth">
      </div>
    </div>
    <div class="form-row" id="div-input-selectText" style="display: none">
      <label for="node-input-selectText"><i class="fa fa-tag"></i><span
              data-i18n="browser.label.select-text-contains"></span></label>
      <input type="text" id="node-input-selectText">
    </div>
    <div class="form-row" id="div-input-selectValue" style="display: none">
      <label for="node-input-selectValue"><i class="fa fa-tag"></i><span
              data-i18n="browser.label.select-value-contains"></span></label>
      <input type="text" id="node-input-selectValue">
    </div>
  </div>
  <!-- 下拉选项区域(多选) -->
  <div class="form-row" id="div-input-selectMultipleOptionWarp" style="display: none">
    <div class="form-row">
      <input type="hidden" id="node-input-selectArray"/>
    </div>
    <div class="form-row node-input-selected-container-row">
      <ol id="node-input-selected-container"></ol>
    </div>
  </div>
</script>
