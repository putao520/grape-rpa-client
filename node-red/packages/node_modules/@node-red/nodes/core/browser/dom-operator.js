const page_store = require("./lib/pageStore");
const playwright = require("playwright");
const {getSelector} = require("./lib/dom-common");
const {operatorFormModel} = require("./lib/dom-operator-selector-handle")

module.exports = function(RED) {
    "use strict";
    function doOperatorRouter(page, target, config){
        return operatorFormModel[config.operator](page, target, config)
    }

    function DomOperatorNode(config) {
        RED.nodes.createNode(this,config);
        const node = this;
        const pageStore = page_store.createPageObject(node, playwright)
        node.on('input',function(msg, send, done) {
            const target = getSelector(config.selectorType, config.selector)
            pageStore.get(config.browserName).then( arr =>{
                const fnArr = []
                arr.map( o=> {
                    fnArr.push(new Promise( (resolve, reject)=>{
                        if( o === undefined ){
                            reject(new Error("需要先打开一个网页"));
                        }
                        const page = o.page
                        doOperatorRouter(page, target, config).then(()=>{
                            resolve(msg)
                        }).catch(e=>{
                            reject(e)
                        })
                    }))
                })
                Promise.all(fnArr).then( arr=>{
                    node.send(msg)
                    done()
                }).catch(e=>{
                    done(e)
                })
            } ).catch(e=>{
                done(e)
            })
        });
    }
    RED.nodes.registerType("dom-operator", DomOperatorNode);
}
