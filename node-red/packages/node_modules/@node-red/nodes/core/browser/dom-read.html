<!-- reader -->
<script type="text/javascript">
    RED.nodes.registerType('dom-read', {
        category: 'browser',
        color: '#a6bbcf',
        defaults: {
            batchMode: {value: false},
            browserName: {value: "", required: true},
            selector: {value: "", required: true},
            selectorName: {value: "", required: true},
            selectorType: {value: "xpath"},
            readItem: {value: "", required: true},
            saveName: {value: "", required: true},
            selectedStyle: {value: ""},
            allStyle: {value: ""},
            selectedProps: {value: ""},
            allProps: {value: ""},
        },
        inputs: 1,
        outputs: 1,
        icon: "file.png",
        paletteLabel: RED._("node-red:browser.dom-read"),
        label: function () {
            if (!this.selector) {
                return this._("browser.dom-read");
            }
            let label = ""
            const labelArr = this.readItem.split(',')
            labelArr.forEach(v=>{
                label += (this._("browser.read." + v) + ",");
            })
            label = label.length > 0 ? label.substring(0, label.length - 1) : label
            return label + (this.selectorName ? "->" + this._("browser.operator.target") + ":" + this.selectorName : "")
        },
        oneditprepare: function () {
            const _self = this
            initBrowserDialog(this, onXpathChange)
            // 根据选项设置内容显示
            $("#node-input-readItem").on("change", () => {
                const v = $("#node-input-readItem").val()
                SwitchReadAreaDom(v)
            });
            // 判断 saveName 是否重复
            $("#node-input-saveName").on("change", () => {
                const v = $("#node-input-saveName").val()
                if (v !== '') {
                    if (!isValidVariableName(this, RED, v)) {
                        $("#node-input-saveName").val("")
                        RED.notify(RED._("node-red:browser.read.saveAsWarn"), {type: "error", timeout: 10000});
                    }
                }
            });

            // 初始化选择器触发器
            /*
            $("#node-input-readItem").typedInput({
                types: [{
                    value: "input-value",
                    multiple: "true",
                    options: [
                        { value: "input-value", label: RED._("node-red:browser.read.input-value")},
                        { value: "edit", label: RED._("node-red:browser.read.edit")},
                        { value: "enable", label: RED._("node-red:browser.read.enable")},
                    ]
                }]
            })
            */
            buildDialogComponents(this)
            // 初始化读取项目
            init_reader_selector(readTable, "#node-input-selector", "#node-input-readItem", this.readItem)
        },
        oneditsave: function () {
            closeBrowserDialog(this)
        },
        oneditcancel: function () {
            closeBrowserDialog(this)
        }
    });

    // xpath 改变
    function onXpathChange(result){
        if (result) {
            // 复制全部可用式样到隐藏域
            const selectedStyle = this.components['selectedStyle']
            $("#node-input-allStyle").val(Object.keys(result.css).join(','))
            selectedStyle.updateOptions(result.css)
            // 复制全部可用属性到隐藏域
            const selectedProps = this.components['selectedProps']
            $("#node-input-allProps").val(Object.keys(result.props).join(','))
            selectedProps.updateOptions(result.props)
        }
    }

    function buildDialogComponents(_self){
        // 构造组件对象组
        this.components = {}
        // 初始化读取式样
        this.components['selectedStyle'] = new InitReadSelectedComponents("#node-input-selectedStyle", array2Options(_self.allStyle))
        // 初始化读取属性
        this.components['selectedProps'] = new InitReadSelectedComponents("#node-input-selectedProps", array2Options(_self.allProps))
    }

    function SwitchReadAreaDom(v) {
        readTable.switch(v)
    }
    const readTable = new readFormSwitch(RED);
</script>

<script type="text/html" data-template-name="dom-read">
    <div class="form-row">
        <label><i class="fa fa-tag"></i><span data-i18n="browser.label.batch"></span></label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-batchMode"><label style="width:auto; margin-top:7px;" for="node-input-batchMode"><span data-i18n="browser.mode.batch"></span></label><br/>
    </div>
    <div class="form-row">
        <label for="node-input-browserName"><i class="fa fa-tag"></i><span data-i18n="browser.label.browserName"></span></label>
        <select id="node-input-browserName">
        </select>
    </div>
    <!-- 元素库 -->
    <div class="form-row">
        <label for="node-input-domLibrary"><i class="fa fa-tag"></i><span
                data-i18n="browser.label.domLibrary"></span></label>
        <select style="width:150px" id="node-input-domLibrary">
        </select>
        <button id="node-input-catchBtn" type="button" class="red-ui-button" data-i18n="browser.label.findDom"></button>
    </div>
    <div class="form-row">
        <label htmlFor="node-input-selector"><i class="fa fa-tag"></i><span
                data-i18n="browser.label.selector"></span></label>
        <input type="text" id="node-input-selector">
        <input type="hidden" id="node-input-selectorType">
    </div>
    <div class="form-row">
        <label htmlFor="node-input-selectorName"><i class="fa fa-tag"></i><span
                data-i18n="browser.label.selector-name"></span></label>
        <input type="text" id="node-input-selectorName">
    </div>
    <!-- 读取的项目 -->
    <div class="form-row">
        <label htmlFor="node-input-readItem"><i class="fa fa-tag"></i><span
                data-i18n="browser.label.read-item"></span></label>
        <input type="text" id="node-input-readItem">
    </div>
    <!-- 保存到遍历 -->
    <div class="form-row">
        <label htmlFor="node-input-saveName"><i class="fa fa-tag"></i><span
                data-i18n="browser.label.save-as"></span></label>
        <input type="text" id="node-input-saveName">
    </div>
    <!-- 任意式样 -->
    <div class="form-row" id="div-input-selectedStyle" style="display: none">
        <label htmlFor="node-input-selectedStyle"><i class="fa fa-tag"></i><span
                data-i18n="browser.read.selected-style"></span></label>
        <input type="text" id="node-input-selectedStyle">
    </div>
    <div class="form-row">
        <input type="hidden" id="node-input-allStyle">
    </div>
    <!-- 任意属性 -->
    <div class="form-row" id="div-input-selectedProps" style="display: none">
        <label htmlFor="node-input-selectedProps"><i class="fa fa-tag"></i><span
                data-i18n="browser.read.selected-props"></span></label>
        <input type="text" id="node-input-selectedProps">
    </div>
    <div class="form-row">
        <input type="hidden" id="node-input-allProps">
    </div>
</script>
