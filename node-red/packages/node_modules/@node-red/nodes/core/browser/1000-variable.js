const playwright = require("playwright");
module.exports = function(RED) {
    "use strict";
    // ------------------------------- variable-remove
    function VariableRemove(config) {
        RED.nodes.createNode(this, config);
        const node = this;
        node.on('input', function (msg, send, done) {
            const vArr = config.variableName.split(',')
            if( vArr.length > 0 ){
                vArr.forEach(v=>{
                    if( v !== ''){
                        delete msg[v]
                    }
                })
            }
            node.send(msg);
            done()
        });
    }
    RED.nodes.registerType("variable-remove", VariableRemove);
    // ------------------------------- variable-aggregate
    function VariableAggregate(config) {
        RED.nodes.createNode(this, config);
        const node = this;
        node.on('input', function (msg, send, done) {
            const vArr = config.variableName.split(',')
            const result = []
            // 获得最小字段
            let min_field = 1000000000
            if( vArr.length > 0 ){
                vArr.forEach(v=>{
                    if( msg[v].length < min_field ){
                        min_field = msg[v].length
                    }
                })
            }
            // 聚合
            for(let i =0; i < min_field; i++){
                const obj = {}
                vArr.forEach(v=>{
                    obj[v] = msg[v][i]
                })
                result.push(obj)
            }
            // 传递
            msg.payload = result
            node.send(msg);
            done()
        });
    }
    RED.nodes.registerType("variable-aggregate", VariableAggregate);
}
