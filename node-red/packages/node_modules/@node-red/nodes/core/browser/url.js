const { chromium } = require('playwright-extra')
const stealth = require('puppeteer-extra-plugin-stealth')()
chromium.use(stealth)
const ua = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36 Edg/103.0.1264.71"
module.exports = function(RED) {
    "use strict";
    const page_store = require('./lib/pageStore')
    // --------------------- open
    function OpenUrlNode(config) {
        RED.nodes.createNode(this,config);
        const node = this;
        const pageStore = page_store.createPageObject(node)
        // 挂接浏览器到RED
        RED.server.pageStore = pageStore
        node.on('input',function(msg, send, done) {
            if (config.url !== "") {
                chromium.launch({
                // channel: 'msedge',
                    headless: config.mode,
                    user_agent: ua })
					.then(browser => {
                    // browser.route('**', route => route.continue());
						pageStore.newPage(browser, config).then(o => {
							node.send(msg)
							done()
						} ).catch(e=>{
							browser.close().then(()=>{
								done(e)
							})
						})
                }).catch(e => {
                    done(new Error(e))
                });
            } else {
                done(new Error("url is empty"))
            }
        });
    }
    RED.nodes.registerType("open-url",OpenUrlNode);

    // --------------------- close
    function CloseUrlNode(config) {
        RED.nodes.createNode(this,config);
        const node = this;
        const pageStore = page_store.createPageObject(node)
        node.on('input',function(msg, send, done) {
            // console.log(`target: ${config.browserName}`)
            if( config.debug === false){
                pageStore.del(config.browserName).then(()=>{
                    node.send(msg)
                    done()
                }).catch(e=>{
                    done(new Error(e))
                })
            } else {
                pageStore.rm(config.browserName)
                done()
            }
        });
    }
    RED.nodes.registerType("close-url",CloseUrlNode);
}
